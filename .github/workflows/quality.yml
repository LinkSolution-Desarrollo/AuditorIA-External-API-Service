name: Code Quality

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: read
  security-events: write

jobs:
  # ─────────────────────────────────────────────
  # 1. Hadolint — linting del Dockerfile raíz
  # ─────────────────────────────────────────────
  hadolint:
    name: Hadolint (Dockerfile)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error
          format: sarif
          output-file: hadolint.sarif
          no-fail: true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint.sarif
          category: hadolint

  # ─────────────────────────────────────────────
  # 2. actionlint — linting de los workflows
  # ─────────────────────────────────────────────
  actionlint:
    name: actionlint (workflows)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Run actionlint
        uses: rhysd/actionlint@v1
        with:
          flags: "-color"

  # ─────────────────────────────────────────────
  # 3. Bandit — SAST Python
  # ─────────────────────────────────────────────
  bandit:
    name: Bandit (SAST)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install bandit
        run: pip install bandit[sarif]

      - name: Run bandit
        run: |
          bandit -r app/ -ll -ii \
            --format sarif \
            --output bandit-report.sarif \
          || true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-report.sarif
          category: bandit

  # ─────────────────────────────────────────────
  # 4. pip check — conflictos de dependencias
  # ─────────────────────────────────────────────
  pip-check:
    name: pip check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: pip check
        run: pip check

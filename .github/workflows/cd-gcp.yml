name: CD â€” GCP Cloud Run (External API)

on:
  push:
    branches: [main]
    paths:
      - "app/**"
      - "requirements.txt"
      - "Dockerfile"
  workflow_dispatch:

concurrency:
  group: cd-gcp-main
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: test-cloud-01-463920
  GCP_REGION: southamerica-west1
  AR_REPO: southamerica-west1-docker.pkg.dev/test-cloud-01-463920/auditoria

jobs:
  deploy:
    name: Deploy External API
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build & push image
        run: |
          IMAGE="${{ env.AR_REPO }}/external-api:${{ github.sha }}"
          IMAGE_LATEST="${{ env.AR_REPO }}/external-api:latest"

          docker build \
            --tag "$IMAGE" \
            --tag "$IMAGE_LATEST" \
            --cache-from "$IMAGE_LATEST" \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          docker push "$IMAGE"
          docker push "$IMAGE_LATEST"
        env:
          DOCKER_BUILDKIT: 1

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy auditoria-external-api \
            --image "${{ env.AR_REPO }}/external-api:${{ github.sha }}" \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }} \
            --quiet

      - name: Verify deployment
        run: |
          URL=$(gcloud run services describe auditoria-external-api \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "External API URL: $URL"
          curl --fail --silent --max-time 30 "$URL/health" || \
          curl --fail --silent --max-time 30 "$URL/docs" || \
          echo "Health check no disponible, verificar manualmente"
